<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>osLET Form Designer - Visual IDE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Liberation+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #1e1e1e;
            --bg-medium: #2b2b2b;
            --bg-light: #3e3e3e;
            --border: #555;
            --text: #e0e0e0;
            --text-dim: #999;
            --accent: #007acc;
            --accent-hover: #005a9e;
            --selection: #ffa500;
        }

        body {
            font-family: 'Liberation Sans', Arial, sans-serif;
            background: var(--bg-medium);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Menu Bar */
        #menubar {
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border);
            display: flex;
            padding: 0 10px;
            height: 32px;
            align-items: center;
            gap: 5px;
        }

        .menu-item {
            padding: 5px 10px;
            cursor: pointer;
            font-size: 13px;
            position: relative;
        }

        .menu-item:hover {
            background: var(--bg-light);
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            min-width: 180px;
            z-index: 10000;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
        }

        .menu-item:hover .menu-dropdown {
            display: block;
        }

        .menu-dropdown-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-dropdown-item:hover {
            background: var(--accent);
        }

        .menu-dropdown-item .shortcut {
            color: var(--text-dim);
            margin-left: 20px;
            font-size: 11px;
        }

        .menu-separator {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* Main Layout */
        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Project Panel */
        #project-panel {
            width: 240px;
            background: var(--bg-dark);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #project-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        #project-name {
            font-size: 13px;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .project-meta {
            font-size: 11px;
            color: var(--text-dim);
            margin: 2px 0;
        }

        #forms-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .form-item {
            background: var(--bg-medium);
            padding: 8px 10px;
            margin-bottom: 6px;
            border-radius: 3px;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-item:hover {
            background: var(--bg-light);
        }

        .form-item.active {
            border-color: var(--accent);
            background: #1e3a5f;
        }

        .form-item-name {
            font-size: 12px;
            font-weight: bold;
        }

        .form-item-info {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .form-delete-btn {
            background: #c00;
            color: white;
            border: none;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            border-radius: 2px;
        }

        .form-delete-btn:hover {
            background: #e00;
        }

        #add-form-btn {
            margin: 8px;
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 3px;
            font-size: 12px;
        }

        #add-form-btn:hover {
            background: var(--accent-hover);
        }

        /* Toolbox */
        #toolbox {
            width: 160px;
            background: var(--bg-dark);
            padding: 10px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }

        .toolbox-section {
            margin-bottom: 15px;
        }

        .toolbox-header {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 6px;
            font-weight: bold;
        }

        .tool-btn {
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 7px;
            margin-bottom: 4px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 12px;
            border-radius: 2px;
        }

        .tool-btn:hover {
            background: var(--bg-medium);
        }

        .tool-btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Canvas */
        #canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #toolbar {
            background: var(--bg-dark);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 8px;
            border-right: 1px solid var(--border);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 5px 10px;
            cursor: pointer;
            font-size: 11px;
            border-radius: 2px;
        }

        .toolbar-btn:hover {
            background: var(--bg-medium);
        }

        .toolbar-label {
            font-size: 11px;
            color: var(--text-dim);
            margin-right: 4px;
        }

        .toolbar-input {
            background: var(--bg-medium);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px 8px;
            font-size: 11px;
            width: 60px;
        }

        #canvas {
            flex: 1;
            position: relative;
            overflow: auto;
            background: var(--bg-medium);
            padding: 20px;
        }

        #canvas.grid-enabled {
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 7px, rgba(255,255,255,0.05) 7px, rgba(255,255,255,0.05) 8px),
                repeating-linear-gradient(90deg, transparent, transparent 7px, rgba(255,255,255,0.05) 7px, rgba(255,255,255,0.05) 8px);
        }

        #screen-bounds {
            width: 640px;
            height: 480px;
            background: #008080;
            border: 2px solid #666;
            position: relative;
            margin: 0 auto;
        }

        #form-designer {
            position: absolute;
            background: #c0c0c0;
            box-sizing: border-box;
            /* Outer border - dark */
            border: 1px solid #000;
            /* Inner border - will be done with pseudo-element */
        }

        #form-designer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 1px solid #555;
            pointer-events: none;
            z-index: 0;
        }

        #form-designer::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            border: 1px solid #a0a0a0;
            pointer-events: none;
            z-index: 0;
        }

        #form-designer.selected {
            outline: 2px dashed var(--selection);
            outline-offset: 2px;
        }

        .form-titlebar {
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            background: #1e1e64;
            color: white;
            height: 18px;
            display: flex;
            align-items: center;
            padding: 0 5px;
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 1.2px;
            cursor: move;
            user-select: none;
            z-index: 2;
        }

        .form-content {
            position: absolute;
            left: 2px;
            top: 20px;
            right: 2px;
            bottom: 2px;
            background: #ffffff;
            overflow: hidden;
            z-index: 1;
        }

        .control {
            position: absolute;
            cursor: move;
            border: 1px dashed transparent;
        }

        .control.selected {
            border: 1px dashed var(--selection);
            outline: 1px solid var(--selection);
        }

        .control-button {
            background: #a0a0a0;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: #000;
            user-select: none;
            letter-spacing: 1px;
            box-sizing: border-box;
            position: relative;
        }

        .control-button::after {
            content: '';
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            border: 1px solid;
            border-top-color: #ffffff;
            border-left-color: #ffffff;
            border-right-color: #555555;
            border-bottom-color: #555555;
            pointer-events: none;
        }

        .control-label {
            font-size: 12px;
            user-select: none;
            white-space: pre;
            padding: 2px;
            box-sizing: border-box;
            display: inline-block;
            line-height: 1.2;
            letter-spacing: 1px;
        }

        .control-textbox {
            background: white;
            font-size: 12px;
            padding: 3px;
            box-sizing: border-box;
            position: relative;
            /* No outer border - textbox uses only 3D sunken border */
            border: none;
        }

        .control-textbox::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-width: 1px;
            border-style: solid;
            border-top-color: #808080;
            border-left-color: #808080;
            border-right-color: #dfdfdf;
            border-bottom-color: #dfdfdf;
            pointer-events: none;
        }

        .control-textbox::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            border-width: 1px;
            border-style: solid;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: transparent;
            border-bottom-color: transparent;
            pointer-events: none;
        }

        .control-checkbox {
            display: flex;
            align-items: center;
        }

        .checkbox-box {
            width: 13px;
            height: 13px;
            background: white;
            position: relative;
            margin-right: 5px;
            border: none;
        }

        .checkbox-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-width: 1px;
            border-style: solid;
            border-top-color: #808080;
            border-left-color: #808080;
            border-right-color: #dfdfdf;
            border-bottom-color: #dfdfdf;
            box-shadow: inset 1px 1px 0 #404040;
        }

        .checkbox-box.checked::after {
            content: '✓';
            position: absolute;
            left: 1px;
            top: -2px;
            font-size: 12px;
            font-weight: bold;
            color: #000;
        }

        .control-picturebox {
            background: #555;
            border: 1px solid #a0a0a0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 10px;
            box-sizing: border-box;
        }

        .control-frame {
            background: transparent;
            position: relative;
            border: 1px solid #808080;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }

        .frame-label {
            position: absolute;
            top: -8px;
            left: 8px;
            background: #ffffff;
            padding: 0 4px;
            font-size: 12px;
            color: #000;
            z-index: 1;
            line-height: 1.2;
        }

        .control-dropdown {
            background: white;
            display: flex;
            align-items: stretch;
            font-size: 12px;
            user-select: none;
            box-sizing: border-box;
        }

        .control-dropdown .dropdown-field {
            flex: 1;
            padding: 3px 4px;
            border-top: 1px solid #808080;
            border-left: 1px solid #808080;
            border-bottom: 1px solid #dfdfdf;
            border-right: none;
            box-shadow: inset 1px 1px 0 #404040;
            overflow: hidden;
            white-space: nowrap;
        }

        .control-dropdown .dropdown-btn {
            width: 16px;
            background: #a0a0a0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #000;
            box-sizing: border-box;
        }

        .control-dropdown .dropdown-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 1px solid;
            border-top-color: #ffffff;
            border-left-color: #ffffff;
            border-right-color: #555555;
            border-bottom-color: #555555;
            pointer-events: none;
        }

        .control-dropdown .dropdown-arrow {
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid black;
        }

        .control-radiobutton {
            display: flex;
            align-items: center;
        }

        .radio-circle {
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            border-radius: 50%;
            background: white;
            margin-right: 5px;
            position: relative;
            box-shadow: inset 0 0 0 1px #808080;
        }

        .radio-circle.checked::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #000;
            border-radius: 50%;
            top: 3px;
            left: 3px;
        }

        .resize-handle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--selection);
            border: 1px solid #000;
            z-index: 10;
        }

        .resize-handle.br {
            right: -3px;
            bottom: -3px;
            cursor: nwse-resize;
        }

        /* Properties Panel */
        #properties-panel {
            width: 260px;
            background: var(--bg-dark);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #properties-header {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            font-weight: bold;
        }

        #properties-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .prop-group {
            margin-bottom: 12px;
        }

        .prop-label {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 3px;
        }

        .prop-input {
            width: 100%;
            background: var(--bg-light);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 5px;
            font-size: 11px;
            font-family: inherit;
        }

        select.prop-input {
            padding: 4px;
        }

        textarea.prop-input {
            resize: vertical;
            min-height: 50px;
            font-family: 'Courier New', monospace;
        }

        .prop-group button {
            width: 100%;
            margin-top: 5px;
            background: var(--accent);
            border: none;
            color: white;
            padding: 6px;
            cursor: pointer;
            font-size: 11px;
            border-radius: 2px;
        }

        .prop-group button:hover {
            background: var(--accent-hover);
        }

        /* Action Editor */
        .action-editor {
            background: var(--bg-medium);
            border: 1px solid var(--border);
            padding: 8px;
            margin-top: 5px;
            border-radius: 3px;
        }

        .action-type-select {
            width: 100%;
            margin-bottom: 8px;
        }

        .action-params {
            display: none;
        }

        .action-params.visible {
            display: block;
        }

        /* Code Panel */
        #code-panel {
            height: 0;
            background: var(--bg-dark);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: height 0.3s;
        }

        #code-panel.open {
            height: 300px;
        }

        #code-header {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #code-tabs {
            display: flex;
            gap: 4px;
        }

        .code-tab {
            padding: 5px 12px;
            background: var(--bg-medium);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 11px;
            border-radius: 3px 3px 0 0;
        }

        .code-tab.active {
            background: var(--bg-light);
            border-bottom-color: var(--bg-light);
        }

        #code-content {
            flex: 1;
            overflow: hidden;
        }

        #code-editor {
            width: 100%;
            height: 100%;
            background: var(--bg-light);
            color: var(--text);
            border: none;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: none;
        }

        /* Buttons */
        button {
            background: var(--accent);
            border: none;
            color: white;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            border-radius: 2px;
        }

        button:hover {
            background: var(--accent-hover);
        }

        button.secondary {
            background: var(--bg-light);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background: var(--bg-medium);
        }

        /* Modal Dialogs */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        /* Snippets Library */
        .snippet-item {
            background: var(--bg-medium);
            border: 1px solid var(--border);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 3px;
            cursor: pointer;
        }

        .snippet-item:hover {
            background: var(--bg-light);
        }

        .snippet-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .snippet-desc {
            font-size: 10px;
            color: var(--text-dim);
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
    </style>
</head>
<body>
    <!-- Menu Bar -->
    <div id="menubar">
        <div class="menu-item">
            File
            <div class="menu-dropdown">
                <div class="menu-dropdown-item" onclick="newProject()">New Project</div>
                <div class="menu-dropdown-item" onclick="openProject()">Open Project<span class="shortcut">Ctrl+O</span></div>
                <div class="menu-dropdown-item" onclick="saveProject()">Save Project<span class="shortcut">Ctrl+S</span></div>
                <div class="menu-separator"></div>
                <div class="menu-dropdown-item" onclick="exportCode()">Export Code<span class="shortcut">Ctrl+E</span></div>
                <div class="menu-dropdown-item" onclick="importCode()">Import Code</div>
            </div>
        </div>
        <div class="menu-item">
            Edit
            <div class="menu-dropdown">
                <div class="menu-dropdown-item" onclick="undo()">Undo<span class="shortcut">Ctrl+Z</span></div>
                <div class="menu-dropdown-item" onclick="redo()">Redo<span class="shortcut">Ctrl+Y</span></div>
                <div class="menu-separator"></div>
                <div class="menu-dropdown-item" onclick="deleteSelected()">Delete<span class="shortcut">Del</span></div>
                <div class="menu-dropdown-item" onclick="duplicateSelected()">Duplicate<span class="shortcut">Ctrl+D</span></div>
            </div>
        </div>
        <div class="menu-item">
            View
            <div class="menu-dropdown">
                <div class="menu-dropdown-item" onclick="toggleGrid()">Toggle Grid<span class="shortcut">Ctrl+G</span></div>
                <div class="menu-dropdown-item" onclick="toggleCode()">Toggle Code Panel<span class="shortcut">F7</span></div>
            </div>
        </div>
        <div class="menu-item">
            Project
            <div class="menu-dropdown">
                <div class="menu-dropdown-item" onclick="projectSettings()">Project Settings</div>
                <div class="menu-dropdown-item" onclick="showGlobals()">Global Variables</div>
                <div class="menu-dropdown-item" onclick="showHelpers()">Helper Functions</div>
                <div class="menu-separator"></div>
                <div class="menu-dropdown-item" onclick="showSnippets()">Code Snippets</div>
            </div>
        </div>
        <div class="menu-item">
            Tools
            <div class="menu-dropdown">
                <div class="menu-dropdown-item" onclick="alignControls('left')">Align Left</div>
                <div class="menu-dropdown-item" onclick="alignControls('top')">Align Top</div>
                <div class="menu-separator"></div>
                <div class="menu-dropdown-item" onclick="sameSize('width')">Same Width</div>
                <div class="menu-dropdown-item" onclick="sameSize('height')">Same Height</div>
            </div>
        </div>
    </div>

    <div id="main-container">
        <!-- Project Panel -->
        <div id="project-panel">
            <div id="project-header">
                <div id="project-name">Untitled Project</div>
                <div class="project-meta">Type: <span id="project-type">ELF Binary</span></div>
                <div class="project-meta">Forms: <span id="project-forms-count">0</span></div>
            </div>
            <div id="forms-list"></div>
            <button id="add-form-btn" onclick="addForm()">+ Add Form</button>
        </div>

        <!-- Toolbox -->
        <div id="toolbox">
            <div class="toolbox-section">
                <div class="toolbox-header">Selection</div>
                <button class="tool-btn active" data-tool="select" onclick="selectTool(this, 'select')">⬆ Select</button>
            </div>
            <div class="toolbox-section">
                <div class="toolbox-header">Controls</div>
                <button class="tool-btn" data-tool="button" onclick="selectTool(this, 'button')">Button</button>
                <button class="tool-btn" data-tool="label" onclick="selectTool(this, 'label')">Label</button>
                <button class="tool-btn" data-tool="textbox" onclick="selectTool(this, 'textbox')">TextBox</button>
                <button class="tool-btn" data-tool="checkbox" onclick="selectTool(this, 'checkbox')">CheckBox</button>
                <button class="tool-btn" data-tool="radiobutton" onclick="selectTool(this, 'radiobutton')">RadioButton</button>
                <button class="tool-btn" data-tool="picturebox" onclick="selectTool(this, 'picturebox')">PictureBox</button>
                <button class="tool-btn" data-tool="frame" onclick="selectTool(this, 'frame')">Frame</button>
                <button class="tool-btn" data-tool="dropdown" onclick="selectTool(this, 'dropdown')">DropDown</button>
            </div>
        </div>

        <!-- Canvas Area -->
        <div id="canvas-area">
            <div id="toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="alignControls('left')">⇤ Left</button>
                    <button class="toolbar-btn" onclick="alignControls('right')">Right ⇥</button>
                    <button class="toolbar-btn" onclick="alignControls('top')">⇡ Top</button>
                    <button class="toolbar-btn" onclick="alignControls('bottom')">Bottom ⇣</button>
                </div>
                <div class="toolbar-group">
                    <span class="toolbar-label">Grid:</span>
                    <input type="number" id="grid-size" class="toolbar-input" value="8" min="1" max="32" onchange="updateGrid()">
                    <label style="font-size: 11px; margin-left: 4px;">
                        <input type="checkbox" id="snap-to-grid" checked onchange="updateSnapToGrid()"> Snap
                    </label>
                </div>
            </div>

            <div id="canvas" class="grid-enabled">
                <div id="screen-bounds">
                    <div id="form-designer" style="left: 100px; top: 80px; width: 400px; height: 300px;">
                        <div class="form-titlebar">
                            <span id="form-title">Form1</span>
                        </div>
                        <div class="form-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Panel -->
        <div id="properties-panel">
            <div id="properties-header">Properties</div>
            <div id="properties-content">
                <p style="font-size: 11px; color: var(--text-dim); text-align: center; margin-top: 20px;">
                    Select a form or control to view properties
                </p>
            </div>
        </div>
    </div>

    <!-- Code Panel -->
    <div id="code-panel">
        <div id="code-header">
            <div id="code-tabs">
                <div class="code-tab active">Generated Code</div>
            </div>
            <button onclick="copyCode()">Copy Code</button>
        </div>
        <div id="code-content">
            <textarea id="code-editor" readonly></textarea>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="project-settings-modal">
        <div class="modal">
            <div class="modal-title">Project Settings</div>
            <div class="prop-group">
                <div class="prop-label">Project Name</div>
                <input type="text" class="prop-input" id="modal-project-name" value="myapp">
            </div>
            <div class="prop-group">
                <div class="prop-label">Project Type</div>
                <select class="prop-input" id="modal-project-type">
                    <option value="elf">ELF Binary (Standalone Program)</option>
                    <option value="module">Progman Module (Applet)</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button onclick="applyProjectSettings()">Apply</button>
                <button class="secondary" onclick="closeModal('project-settings-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="globals-modal">
        <div class="modal">
            <div class="modal-title">Global Variables</div>
            <p style="font-size: 11px; color: var(--text-dim); margin-bottom: 10px;">
                Define global variables accessible from all event handlers:
            </p>
            <textarea id="globals-editor" class="prop-input" rows="10" style="width: 100%; font-family: 'Courier New', monospace;">/* Example:
static int counter = 0;
static char buffer[256];
*/</textarea>
            <div class="modal-buttons">
                <button onclick="saveGlobals()">Save</button>
                <button class="secondary" onclick="closeModal('globals-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="helpers-modal">
        <div class="modal">
            <div class="modal-title">Helper Functions</div>
            <p style="font-size: 11px; color: var(--text-dim); margin-bottom: 10px;">
                Define helper functions for reusable code:
            </p>
            <textarea id="helpers-editor" class="prop-input" rows="15" style="width: 100%; font-family: 'Courier New', monospace;">/* Example:
static void show_error(const char *msg) {
    msgbox_t box;
    win_msgbox_create(&box, msg, "OK", "Error");
    sys_win_show_msgbox(&box);
}
*/</textarea>
            <div class="modal-buttons">
                <button onclick="saveHelpers()">Save</button>
                <button class="secondary" onclick="closeModal('helpers-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="snippets-modal">
        <div class="modal">
            <div class="modal-title">Code Snippets</div>
            <p style="font-size: 11px; color: var(--text-dim); margin-bottom: 10px;">
                Click to copy common code patterns to clipboard:
            </p>
            <div id="snippets-list"></div>
            <div class="modal-buttons">
                <button class="secondary" onclick="closeModal('snippets-modal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="import-modal">
        <div class="modal" style="width: 600px; max-width: 90vw;">
            <div class="modal-title">Import C File</div>
            <p style="font-size: 11px; color: var(--text-dim); margin-bottom: 10px;">
                Select a .c file to import. Supports both new designer format and legacy programs (e.g., calculator.c).
            </p>
            <div style="margin: 20px 0;">
                <input type="file" id="import-file-input" accept=".c,.h" style="width: 100%; padding: 10px; background: var(--bg-medium); border: 1px solid var(--border); color: var(--text); border-radius: 4px;">
            </div>
            <div style="background: var(--bg-medium); padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                <div style="font-size: 10px; color: var(--text-dim); font-weight: bold; margin-bottom: 5px;">Supported Formats:</div>
                <div style="font-size: 10px; color: var(--text-dim);">• New: sys_win_create_form(&form, x, y, w, h, "Title");</div>
                <div style="font-size: 10px; color: var(--text-dim);">• Legacy: sys_win_create_form("Title", x, y, w, h);</div>
                <div style="font-size: 10px; color: var(--text-dim);">• Legacy: static gui_control_t controls[] = {...};</div>
            </div>
            <div class="modal-buttons">
                <button onclick="parseImportedFile()">Import</button>
                <button class="secondary" onclick="closeModal('import-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global State
        const state = {
            project: {
                name: 'myapp',
                type: 'elf',
                globals: '',
                helpers: '',
                forms: []
            },
            currentFormIndex: -1,
            currentTool: 'select',
            selectedControl: null,
            gridSize: 8,
            snapToGrid: true,
            dragData: null,
            undoStack: [],
            redoStack: []
        };

        // Code Snippets Library
        const codeSnippets = [
            {
                name: 'Show Form',
                desc: 'Display another form',
                code: 'sys_win_draw(formName);\nsys_win_redraw_all();'
            },
            {
                name: 'Hide Form',
                desc: 'Hide the current form',
                code: 'sys_win_restore_background(&((gui_form_t*)formName)->win);\nsys_win_redraw_all();'
            },
            {
                name: 'Message Box',
                desc: 'Display a message box',
                code: `msgbox_t box;\nwin_msgbox_create(&box, "Message text", "OK", "Title");\nsys_win_show_msgbox(&box);`
            },
            {
                name: 'Get Text',
                desc: 'Get text from a control',
                code: 'const char *text = ctrl_get_text(form, CTRL_ID);'
            },
            {
                name: 'Set Text',
                desc: 'Set text of a control',
                code: 'ctrl_set_text(form, CTRL_ID, "New text");\nsys_win_draw(form);'
            },
            {
                name: 'Set Visible',
                desc: 'Show/hide a control',
                code: 'ctrl_set_visible(form, CTRL_ID, 1); /* 1=show, 0=hide */\nsys_win_draw(form);'
            },
            {
                name: 'Get Checked',
                desc: 'Get checkbox/radio state',
                code: 'int checked = ctrl_get_checked(form, CTRL_ID);'
            },
            {
                name: 'Set Checked',
                desc: 'Set checkbox/radio state',
                code: 'ctrl_set_checked(form, CTRL_ID, 1); /* 1=checked, 0=unchecked */\nsys_win_draw(form);'
            },
            {
                name: 'Exit Program',
                desc: 'Exit the application',
                code: 'exit_requested = 1;'
            },
            {
                name: 'Load Image',
                desc: 'Load image into PictureBox',
                code: 'ctrl_set_image(form, CTRL_ID, "C:/PATH/IMAGE.BMP");\nsys_win_draw(form);'
            },
            {
                name: 'String Copy',
                desc: 'Safe string copy',
                code: 'char dest[256];\nstrcpy_s(dest, source, sizeof(dest));'
            },
            {
                name: 'String Compare',
                desc: 'Compare strings',
                code: 'if (strcmp(str1, str2) == 0) {\n    /* strings are equal */\n}'
            }
        ];

        // Initialize
        function init() {
            addForm();
            setupEventListeners();
            loadSnippets();
            updateUI();
            generateCode();
        }

        function setupEventListeners() {
            const formDesigner = document.getElementById('form-designer');
            const formContent = document.querySelector('.form-content');
            const canvas = document.getElementById('canvas');

            // Form dragging
            const titlebar = document.querySelector('.form-titlebar');
            titlebar.addEventListener('mousedown', startFormDrag);

            // Control placement
            formContent.addEventListener('click', placeControl);

            // Form selection
            formDesigner.addEventListener('click', (e) => {
                if (e.target === formDesigner || e.target.classList.contains('form-titlebar') || e.target.classList.contains('form-content')) {
                    selectForm();
                    e.stopPropagation();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboard);

            // Canvas click (deselect)
            canvas.addEventListener('click', (e) => {
                if (e.target === canvas || e.target === document.getElementById('screen-bounds')) {
                    deselectAll();
                }
            });
        }

        // Form Management
        function addForm() {
            const formName = `Form${state.project.forms.length + 1}`;
            const form = {
                name: formName,
                title: formName,
                x: 100,
                y: 80,
                w: 400,
                h: 300,
                controls: [],
                nextControlId: 1
            };
            state.project.forms.push(form);
            state.currentFormIndex = state.project.forms.length - 1;
            updateFormsListUI();
            displayForm(state.currentFormIndex);
            saveState();
        }

        function deleteForm(index) {
            if (state.project.forms.length === 1) {
                alert('Cannot delete the last form!');
                return;
            }
            if (confirm(`Delete ${state.project.forms[index].name}?`)) {
                state.project.forms.splice(index, 1);
                if (state.currentFormIndex >= state.project.forms.length) {
                    state.currentFormIndex = state.project.forms.length - 1;
                }
                updateFormsListUI();
                displayForm(state.currentFormIndex);
                saveState();
            }
        }

        function selectFormInList(index) {
            state.currentFormIndex = index;
            displayForm(index);
            updateFormsListUI();
        }

        function displayForm(index) {
            if (index < 0 || index >= state.project.forms.length) return;
            
            const form = state.project.forms[index];
            const formDesigner = document.getElementById('form-designer');
            const formTitle = document.getElementById('form-title');
            const formContent = document.querySelector('.form-content');

            formDesigner.style.left = form.x + 'px';
            formDesigner.style.top = form.y + 'px';
            formDesigner.style.width = form.w + 'px';
            formDesigner.style.height = form.h + 'px';
            formTitle.textContent = form.title;

            // Clear and redraw controls
            formContent.innerHTML = '';
            form.controls.forEach(ctrl => createControlElement(ctrl, formContent));

            selectForm();
        }

        function updateFormsListUI() {
            const listEl = document.getElementById('forms-list');
            listEl.innerHTML = '';

            state.project.forms.forEach((form, index) => {
                const item = document.createElement('div');
                item.className = 'form-item' + (index === state.currentFormIndex ? ' active' : '');
                item.innerHTML = `
                    <div>
                        <div class="form-item-name">${form.name}</div>
                        <div class="form-item-info">${form.w}×${form.h}, ${form.controls.length} controls</div>
                    </div>
                    <button class="form-delete-btn" onclick="event.stopPropagation(); deleteForm(${index})">×</button>
                `;
                item.onclick = () => selectFormInList(index);
                listEl.appendChild(item);
            });

            document.getElementById('project-forms-count').textContent = state.project.forms.length;
        }

        // Tool Selection
        function selectTool(btn, tool) {
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.currentTool = tool;
            document.getElementById('canvas').style.cursor = tool === 'select' ? 'default' : 'crosshair';
        }

        // Control Placement
        function placeControl(e) {
            if (state.currentTool === 'select') return;
            if (state.currentFormIndex < 0) return;

            const form = state.project.forms[state.currentFormIndex];
            const rect = e.currentTarget.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            // Snap to grid
            if (state.snapToGrid) {
                x = Math.round(x / state.gridSize) * state.gridSize;
                y = Math.round(y / state.gridSize) * state.gridSize;
            }

            // Default dimensions
            const defaults = {
                button: { w: 80, h: 24, text: 'Button', bg: -1 },
                label: { w: 60, h: 16, text: 'Label', bg: -1 },
                textbox: { w: 120, h: 20, text: '', bg: 15 },
                checkbox: { w: 80, h: 16, text: 'CheckBox', bg: -1 },
                radiobutton: { w: 80, h: 16, text: 'RadioButton', bg: -1 },
                picturebox: { w: 100, h: 100, text: 'IMAGE.BMP', bg: 7 },
                frame: { w: 150, h: 100, text: 'Frame', bg: -1 },
                dropdown: { w: 120, h: 20, text: 'Option 1|Option 2|Option 3', bg: 15 }
            };

            const def = defaults[state.currentTool];
            const control = {
                type: state.currentTool,
                id: form.nextControlId++,
                x, y,
                w: def.w,
                h: def.h,
                text: def.text,
                fg: 0,
                bg: def.bg,
                font_type: 0,
                font_size: 12,
                border: 0,
                checked: 0,
                group_id: 0,
                max_length: state.currentTool === 'textbox' ? 255 : 0,
                enabled: 1,
                visible: 1,
                action: { type: 'none' }
            };

            form.controls.push(control);
            createControlElement(control, e.currentTarget);
            selectControl(control);
            saveState();
            generateCode();

            // Reset to select tool
            selectTool(document.querySelector('.tool-btn[data-tool="select"]'), 'select');
        }

        // Create Control Element (Visual)
        function createControlElement(control, container) {
            console.log('[createControlElement] Creating control:', control.type, control.id, control.text);
            
            // Remove old element if exists
            if (control.el) {
                control.el.remove();
            }

            const el = document.createElement('div');
            el.className = 'control';
            el.style.left = control.x + 'px';
            el.style.top = control.y + 'px';
            el.dataset.controlId = control.id;

            if (control.type === 'button') {
                el.style.width = control.w + 'px';
                el.style.height = control.h + 'px';
                el.classList.add('control-button');
                el.textContent = control.text;
            } else if (control.type === 'label') {
                el.classList.add('control-label');
                const displayText = control.text.replace(/\\n/g, '\n');
                el.textContent = displayText;
                el.style.fontSize = control.font_size + 'px';
                el.style.lineHeight = '1.2';
                if (control.w > 0) el.style.width = control.w + 'px';
                if (control.h > 0) el.style.height = control.h + 'px';
            } else if (control.type === 'picturebox') {
                el.style.width = control.w + 'px';
                el.style.height = control.h + 'px';
                el.classList.add('control-picturebox');
                el.textContent = '[Image]';
            } else if (control.type === 'checkbox') {
                el.style.width = 'auto';
                el.style.height = '13px';
                el.style.lineHeight = '13px';

                const box = document.createElement('div');
                box.style.width = '13px';
                box.style.height = '13px';
                box.style.display = 'inline-block';
                box.style.verticalAlign = 'middle';
                box.style.borderTop = '1px solid #808080';
                box.style.borderLeft = '1px solid #808080';
                box.style.borderBottom = '1px solid #dfdfdf';
                box.style.borderRight = '1px solid #dfdfdf';
                box.style.backgroundColor = 'white';
                box.style.boxShadow = 'inset 1px 1px 0 #404040';

                if (control.checked) {
                    const svg = `<svg width="13" height="13" xmlns="http://www.w3.org/2000/svg">
                        <line x1="3" y1="3" x2="9" y2="9" stroke="black" stroke-width="1"/>
                        <line x1="4" y1="3" x2="10" y2="9" stroke="black" stroke-width="1"/>
                        <line x1="9" y1="3" x2="3" y2="9" stroke="black" stroke-width="1"/>
                        <line x1="10" y1="3" x2="4" y2="9" stroke="black" stroke-width="1"/>
                    </svg>`;
                    box.innerHTML = svg;
                }

                const label = document.createElement('span');
                label.textContent = control.text;
                label.style.marginLeft = '4px';
                label.style.fontSize = '12px';
                label.style.verticalAlign = 'middle';
                label.style.color = 'black';

                el.appendChild(box);
                el.appendChild(label);
            } else if (control.type === 'radiobutton') {
                el.style.width = 'auto';
                el.style.height = '12px';
                el.style.lineHeight = '12px';

                const circle = document.createElement('div');
                circle.style.width = '12px';
                circle.style.height = '12px';
                circle.style.display = 'inline-block';
                circle.style.verticalAlign = 'middle';
                circle.style.border = '1px solid #808080';
                circle.style.borderRadius = '50%';
                circle.style.backgroundColor = 'white';

                if (control.checked) {
                    const svg = `<svg width="12" height="12" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="6" cy="6" r="2" fill="black"/>
                        <circle cx="6" cy="6" r="1" fill="black"/>
                        <rect x="5.5" y="5.5" width="1" height="1" fill="black"/>
                    </svg>`;
                    circle.innerHTML = svg;
                }

                const label = document.createElement('span');
                label.textContent = control.text;
                label.style.marginLeft = '4px';
                label.style.fontSize = '12px';
                label.style.verticalAlign = 'middle';
                label.style.color = 'black';

                el.appendChild(circle);
                el.appendChild(label);
            } else if (control.type === 'textbox') {
                el.style.width = control.w + 'px';
                el.style.height = control.h + 'px';
                el.style.borderTop = '1px solid #808080';
                el.style.borderLeft = '1px solid #808080';
                el.style.borderBottom = '1px solid #dfdfdf';
                el.style.borderRight = '1px solid #dfdfdf';
                el.style.backgroundColor = 'white';
                el.style.color = 'black';
                el.style.boxShadow = 'inset 1px 1px 0 #404040';
                el.style.fontSize = '12px';
                el.style.padding = '6px 0 0 4px';
                el.style.boxSizing = 'border-box';
                el.style.overflow = 'hidden';
                el.textContent = control.text;
            } else if (control.type === 'dropdown') {
                el.style.width = control.w + 'px';
                el.style.height = control.h + 'px';
                el.classList.add('control-dropdown');

                const field = document.createElement('div');
                field.className = 'dropdown-field';
                const firstItem = control.text.split('|')[0] || '';
                field.textContent = firstItem;

                const btn = document.createElement('div');
                btn.className = 'dropdown-btn';
                btn.style.position = 'relative';

                const arrow = document.createElement('div');
                arrow.className = 'dropdown-arrow';
                btn.appendChild(arrow);

                el.appendChild(field);
                el.appendChild(btn);
            } else if (control.type === 'frame') {
                el.style.width = control.w + 'px';
                el.style.height = control.h + 'px';
                el.style.boxSizing = 'border-box';

                const borderOffset = 8;
                const titleOffset = 8;
                const textWidth = control.text ? control.text.length * 7 : 0;

                // Top left border (before title)
                const topLeft = document.createElement('div');
                topLeft.style.position = 'absolute';
                topLeft.style.top = borderOffset + 'px';
                topLeft.style.left = '0';
                topLeft.style.width = titleOffset + 'px';
                topLeft.style.height = '0';
                topLeft.style.borderTop = '1px solid #808080';
                el.appendChild(topLeft);

                // Top right border (after title)
                if (control.text) {
                    const topRight = document.createElement('div');
                    topRight.style.position = 'absolute';
                    topRight.style.top = borderOffset + 'px';
                    topRight.style.left = (titleOffset + textWidth + 8) + 'px';
                    topRight.style.right = '0';
                    topRight.style.height = '0';
                    topRight.style.borderTop = '1px solid #808080';
                    el.appendChild(topRight);
                }

                // Left border
                const leftBorder = document.createElement('div');
                leftBorder.style.position = 'absolute';
                leftBorder.style.top = borderOffset + 'px';
                leftBorder.style.left = '0';
                leftBorder.style.bottom = '0';
                leftBorder.style.width = '0';
                leftBorder.style.borderLeft = '1px solid #808080';
                el.appendChild(leftBorder);

                // Bottom border
                const bottomBorder = document.createElement('div');
                bottomBorder.style.position = 'absolute';
                bottomBorder.style.bottom = '0';
                bottomBorder.style.left = '0';
                bottomBorder.style.right = '0';
                bottomBorder.style.height = '0';
                bottomBorder.style.borderBottom = '1px solid #dfdfdf';
                el.appendChild(bottomBorder);

                // Right border
                const rightBorder = document.createElement('div');
                rightBorder.style.position = 'absolute';
                rightBorder.style.top = borderOffset + 'px';
                rightBorder.style.right = '0';
                rightBorder.style.bottom = '0';
                rightBorder.style.width = '0';
                rightBorder.style.borderRight = '1px solid #dfdfdf';
                el.appendChild(rightBorder);

                // Title text
                const frameTitle = document.createElement('span');
                frameTitle.textContent = control.text;
                frameTitle.style.position = 'absolute';
                frameTitle.style.top = '0px';
                frameTitle.style.left = '12px';
                frameTitle.style.fontSize = '12px';
                frameTitle.style.lineHeight = '12px';
                frameTitle.style.color = 'black';
                el.appendChild(frameTitle);
            }

            el.onclick = (e) => {
                e.stopPropagation();
                selectControl(control);
                
                // Toggle checked state for checkboxes and radiobuttons
                if (control.type === 'checkbox') {
                    control.checked = control.checked ? 0 : 1;
                    const container = document.querySelector('.form-content');
                    el.remove();
                    createControlElement(control, container);
                    selectControl(control);
                    updatePropertiesPanel(control);
                    saveState();
                    generateCode();
                } else if (control.type === 'radiobutton') {
                    const form = state.project.forms[state.currentFormIndex];
                    // Uncheck other radios in same group
                    form.controls.forEach(c => {
                        if (c.type === 'radiobutton' && c.group_id === control.group_id && c !== control) {
                            c.checked = 0;
                            if (c.el) {
                                c.el.remove();
                                createControlElement(c, document.querySelector('.form-content'));
                            }
                        }
                    });
                    control.checked = 1;
                    const container = document.querySelector('.form-content');
                    el.remove();
                    createControlElement(control, container);
                    selectControl(control);
                    updatePropertiesPanel(control);
                    saveState();
                    generateCode();
                }
            };

            el.onmousedown = (e) => {
                if (state.currentTool !== 'select') return;
                e.stopPropagation();
                startControlDrag(e, control);
            };

            control.el = el;
            container.appendChild(el);
        }

        // Control Selection
        function selectControl(control) {
            deselectAll();
            state.selectedControl = control;
            control.el.classList.add('selected');
            
            // Add resize handle (not for labels, checkboxes, radiobuttons)
            if (control.type !== 'label' && control.type !== 'checkbox' && control.type !== 'radiobutton') {
                const handle = document.createElement('div');
                handle.className = 'resize-handle br';
                handle.onmousedown = (e) => {
                    e.stopPropagation();
                    startResize(e, control);
                };
                control.el.appendChild(handle);
            }

            updatePropertiesPanel(control);
        }

        function selectForm() {
            deselectAll();
            document.getElementById('form-designer').classList.add('selected');
            updateFormProperties();
        }

        function deselectAll() {
            state.selectedControl = null;
            document.querySelectorAll('.control').forEach(el => {
                el.classList.remove('selected');
                const handle = el.querySelector('.resize-handle');
                if (handle) handle.remove();
            });
            document.getElementById('form-designer').classList.remove('selected');
        }

        // Control Dragging
        function startControlDrag(e, control) {
            state.dragData = {
                type: 'control',
                control,
                startX: e.clientX,
                startY: e.clientY,
                origX: control.x,
                origY: control.y
            };
            
            document.onmousemove = dragControl;
            document.onmouseup = stopDrag;
        }

        function dragControl(e) {
            if (!state.dragData || state.dragData.type !== 'control') return;

            let dx = e.clientX - state.dragData.startX;
            let dy = e.clientY - state.dragData.startY;

            let newX = state.dragData.origX + dx;
            let newY = state.dragData.origY + dy;

            if (state.snapToGrid) {
                newX = Math.round(newX / state.gridSize) * state.gridSize;
                newY = Math.round(newY / state.gridSize) * state.gridSize;
            }

            state.dragData.control.x = Math.max(0, newX);
            state.dragData.control.y = Math.max(0, newY);
            state.dragData.control.el.style.left = state.dragData.control.x + 'px';
            state.dragData.control.el.style.top = state.dragData.control.y + 'px';

            updatePropertiesPanel(state.dragData.control);
        }

        function stopDrag() {
            document.onmousemove = null;
            document.onmouseup = null;
            state.dragData = null;
            saveState();
            generateCode();
        }

        // Control Resizing
        function startResize(e, control) {
            state.dragData = {
                type: 'resize',
                control,
                startX: e.clientX,
                startY: e.clientY,
                origW: control.w,
                origH: control.h
            };

            document.onmousemove = resizeControl;
            document.onmouseup = stopDrag;
        }

        function resizeControl(e) {
            if (!state.dragData || state.dragData.type !== 'resize') return;

            let dw = e.clientX - state.dragData.startX;
            let dh = e.clientY - state.dragData.startY;

            let newW = state.dragData.origW + dw;
            let newH = state.dragData.origH + dh;

            if (state.snapToGrid) {
                newW = Math.round(newW / state.gridSize) * state.gridSize;
                newH = Math.round(newH / state.gridSize) * state.gridSize;
            }

            state.dragData.control.w = Math.max(10, newW);
            state.dragData.control.h = Math.max(10, newH);

            // Update element size
            const el = state.dragData.control.el;
            el.style.width = state.dragData.control.w + 'px';
            if (state.dragData.control.type !== 'checkbox' && state.dragData.control.type !== 'radiobutton') {
                el.style.height = state.dragData.control.h + 'px';
            }

            updatePropertiesPanel(state.dragData.control);
        }

        // Form Dragging
        function startFormDrag(e) {
            const form = state.project.forms[state.currentFormIndex];
            if (!form) return;

            state.dragData = {
                type: 'form',
                form,
                startX: e.clientX,
                startY: e.clientY,
                origX: form.x,
                origY: form.y
            };

            document.onmousemove = dragForm;
            document.onmouseup = stopDrag;
        }

        function dragForm(e) {
            if (!state.dragData || state.dragData.type !== 'form') return;

            const dx = e.clientX - state.dragData.startX;
            const dy = e.clientY - state.dragData.startY;

            state.dragData.form.x = Math.max(0, state.dragData.origX + dx);
            state.dragData.form.y = Math.max(0, state.dragData.origY + dy);

            const formDesigner = document.getElementById('form-designer');
            formDesigner.style.left = state.dragData.form.x + 'px';
            formDesigner.style.top = state.dragData.form.y + 'px';
        }

        // Properties Panel
        function updatePropertiesPanel(control) {
            const panel = document.getElementById('properties-content');
            const form = state.project.forms[state.currentFormIndex];

            let html = `
                <div class="prop-group">
                    <div class="prop-label">Control Type</div>
                    <input class="prop-input" value="CTRL_${control.type.toUpperCase()}" disabled>
                </div>
                <div class="prop-group">
                    <div class="prop-label">ID</div>
                    <input class="prop-input" type="number" value="${control.id}" 
                        onchange="updateControlProperty('id', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">X</div>
                    <input class="prop-input" type="number" value="${control.x}" 
                        onchange="updateControlProperty('x', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Y</div>
                    <input class="prop-input" type="number" value="${control.y}" 
                        onchange="updateControlProperty('y', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Width</div>
                    <input class="prop-input" type="number" value="${control.w}" 
                        onchange="updateControlProperty('w', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Height</div>
                    <input class="prop-input" type="number" value="${control.h}" 
                        onchange="updateControlProperty('h', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Text</div>
                    <textarea class="prop-input" rows="2"
                        onchange="updateControlProperty('text', this.value)">${control.text}</textarea>
                </div>
                <div class="prop-group">
                    <div class="prop-label">Foreground Color (0-15)</div>
                    <input class="prop-input" type="number" min="0" max="15" value="${control.fg}" 
                        onchange="updateControlProperty('fg', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Background Color (0-15, -1=default)</div>
                    <input class="prop-input" type="number" min="-1" max="15" value="${control.bg}" 
                        onchange="updateControlProperty('bg', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Font Size</div>
                    <input class="prop-input" type="number" value="${control.font_size}" 
                        onchange="updateControlProperty('font_size', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Font Type</div>
                    <select class="prop-input" onchange="updateControlProperty('font_type', parseInt(this.value))">
                        <option value="0" ${control.font_type === 0 ? 'selected' : ''}>Normal</option>
                        <option value="1" ${control.font_type === 1 ? 'selected' : ''}>Bold</option>
                        <option value="2" ${control.font_type === 2 ? 'selected' : ''}>Italic</option>
                        <option value="3" ${control.font_type === 3 ? 'selected' : ''}>Bold Italic</option>
                    </select>
                </div>
            `;

            // Type-specific properties
            if (control.type === 'checkbox' || control.type === 'radiobutton') {
                html += `
                    <div class="prop-group">
                        <div class="prop-label">Checked</div>
                        <select class="prop-input" onchange="updateControlProperty('checked', parseInt(this.value))">
                            <option value="0" ${control.checked === 0 ? 'selected' : ''}>Unchecked</option>
                            <option value="1" ${control.checked === 1 ? 'selected' : ''}>Checked</option>
                        </select>
                    </div>
                `;
            }

            if (control.type === 'radiobutton') {
                html += `
                    <div class="prop-group">
                        <div class="prop-label">Group ID</div>
                        <input class="prop-input" type="number" value="${control.group_id}" 
                            onchange="updateControlProperty('group_id', parseInt(this.value))">
                    </div>
                `;
            }

            if (control.type === 'textbox') {
                html += `
                    <div class="prop-group">
                        <div class="prop-label">Max Length</div>
                        <input class="prop-input" type="number" value="${control.max_length}" 
                            onchange="updateControlProperty('max_length', parseInt(this.value))">
                    </div>
                `;
            }

            // Event Handler (for buttons)
            if (control.type === 'button') {
                html += `
                    <div class="prop-group">
                        <div class="prop-label">On Click Action</div>
                        <div class="action-editor">
                            <select class="prop-input action-type-select" onchange="updateActionType(this.value)">
                                <option value="none" ${control.action.type === 'none' ? 'selected' : ''}>None</option>
                                <option value="show_form" ${control.action.type === 'show_form' ? 'selected' : ''}>Show Form</option>
                                <option value="hide_form" ${control.action.type === 'hide_form' ? 'selected' : ''}>Hide Form</option>
                                <option value="msgbox" ${control.action.type === 'msgbox' ? 'selected' : ''}>Show Message Box</option>
                                <option value="set_text" ${control.action.type === 'set_text' ? 'selected' : ''}>Set Text</option>
                                <option value="exit" ${control.action.type === 'exit' ? 'selected' : ''}>Exit Program</option>
                                <option value="custom" ${control.action.type === 'custom' ? 'selected' : ''}>Custom Code</option>
                            </select>
                            
                            <div class="action-params ${control.action.type === 'show_form' || control.action.type === 'hide_form' ? 'visible' : ''}" id="action-form-name">
                                <div class="prop-label" style="margin-top: 8px;">Form Name</div>
                                <select class="prop-input" onchange="updateActionParam('form_name', this.value)">
                                    ${state.project.forms.map(f => `<option value="${f.name}" ${control.action.form_name === f.name ? 'selected' : ''}>${f.name}</option>`).join('')}
                                </select>
                            </div>

                            <div class="action-params ${control.action.type === 'msgbox' ? 'visible' : ''}" id="action-msgbox">
                                <div class="prop-label" style="margin-top: 8px;">Message</div>
                                <textarea class="prop-input" rows="2" onchange="updateActionParam('msg', this.value)">${control.action.msg || ''}</textarea>
                                <div class="prop-label" style="margin-top: 8px;">Title</div>
                                <input class="prop-input" value="${control.action.msg_title || 'Message'}" onchange="updateActionParam('msg_title', this.value)">
                            </div>

                            <div class="action-params ${control.action.type === 'set_text' ? 'visible' : ''}" id="action-text">
                                <div class="prop-label" style="margin-top: 8px;">Target Control ID</div>
                                <input class="prop-input" type="number" value="${control.action.target_id || ''}" onchange="updateActionParam('target_id', parseInt(this.value))">
                                <div class="prop-label" style="margin-top: 8px;">Text Value</div>
                                <input class="prop-input" value="${control.action.text_value || ''}" onchange="updateActionParam('text_value', this.value)">
                            </div>

                            <div class="action-params ${control.action.type === 'custom' ? 'visible' : ''}" id="action-custom">
                                <div class="prop-label" style="margin-top: 8px;">Custom Code</div>
                                <textarea class="prop-input" rows="4" style="font-family: 'Courier New', monospace;"
                                    onchange="updateActionParam('custom_code', this.value)">${control.action.custom_code || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }

            panel.innerHTML = html;
        }

        function updateFormProperties() {
            const panel = document.getElementById('properties-content');
            const form = state.project.forms[state.currentFormIndex];

            if (!form) return;

            panel.innerHTML = `
                <div class="prop-group">
                    <div class="prop-label">Form Type</div>
                    <input class="prop-input" value="gui_form_t" disabled>
                </div>
                <div class="prop-group">
                    <div class="prop-label">Form Name</div>
                    <input class="prop-input" value="${form.name}" onchange="updateFormProperty('name', this.value)">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Title</div>
                    <input class="prop-input" value="${form.title}" onchange="updateFormProperty('title', this.value)">
                </div>
                <div class="prop-group">
                    <div class="prop-label">X</div>
                    <input class="prop-input" type="number" value="${form.x}" onchange="updateFormProperty('x', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Y</div>
                    <input class="prop-input" type="number" value="${form.y}" onchange="updateFormProperty('y', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Width</div>
                    <input class="prop-input" type="number" value="${form.w}" onchange="updateFormProperty('w', parseInt(this.value))">
                </div>
                <div class="prop-group">
                    <div class="prop-label">Height</div>
                    <input class="prop-input" type="number" value="${form.h}" onchange="updateFormProperty('h', parseInt(this.value))">
                </div>
            `;
        }

        function updateControlProperty(prop, value) {
            if (!state.selectedControl) return;

            state.selectedControl[prop] = value;

            // Update visual element
            const el = state.selectedControl.el;
            if (prop === 'x') el.style.left = value + 'px';
            if (prop === 'y') el.style.top = value + 'px';
            if (prop === 'w' && state.selectedControl.type !== 'label') el.style.width = value + 'px';
            if (prop === 'h' && state.selectedControl.type !== 'label' && 
                state.selectedControl.type !== 'checkbox' && state.selectedControl.type !== 'radiobutton') {
                el.style.height = value + 'px';
            }
            if (prop === 'text' || prop === 'checked' || prop === 'fg' || prop === 'bg') {
                // Recreate element
                const form = state.project.forms[state.currentFormIndex];
                const container = document.querySelector('.form-content');
                el.remove();
                createControlElement(state.selectedControl, container);
                selectControl(state.selectedControl);
            }

            saveState();
            generateCode();
        }

        function updateFormProperty(prop, value) {
            const form = state.project.forms[state.currentFormIndex];
            if (!form) return;

            form[prop] = value;

            const formDesigner = document.getElementById('form-designer');
            if (prop === 'name' || prop === 'title') {
                document.getElementById('form-title').textContent = form.title;
                updateFormsListUI();
            }
            if (prop === 'x') formDesigner.style.left = value + 'px';
            if (prop === 'y') formDesigner.style.top = value + 'px';
            if (prop === 'w') formDesigner.style.width = value + 'px';
            if (prop === 'h') formDesigner.style.height = value + 'px';

            saveState();
            generateCode();
        }

        function updateActionType(type) {
            if (!state.selectedControl) return;
            state.selectedControl.action.type = type;
            
            // Hide all param sections
            document.querySelectorAll('.action-params').forEach(el => el.classList.remove('visible'));
            
            // Show relevant section
            if (type === 'show_form' || type === 'hide_form') {
                document.getElementById('action-form-name').classList.add('visible');
            } else if (type === 'msgbox') {
                document.getElementById('action-msgbox').classList.add('visible');
            } else if (type === 'set_text') {
                document.getElementById('action-text').classList.add('visible');
            } else if (type === 'custom') {
                document.getElementById('action-custom').classList.add('visible');
            }

            saveState();
            generateCode();
        }

        function updateActionParam(param, value) {
            if (!state.selectedControl) return;
            state.selectedControl.action[param] = value;
            saveState();
            generateCode();
        }

        // Code Generation
        function generateCode() {
            const project = state.project;
            let code = '';

            // Includes
            code += `#include "../syscall.h"\n`;
            code += `#include "../lib/stdio.h"\n`;
            code += `#include "../lib/string.h"\n\n`;

            // Control IDs
            project.forms.forEach(form => {
                if (form.controls.length > 0) {
                    code += `/* ${form.name} Control IDs */\n`;
                    form.controls.forEach(ctrl => {
                        const name = `ID_${form.name.toUpperCase()}_${ctrl.id}`;
                        code += `#define ${name} ${ctrl.id}\n`;
                    });
                    code += '\n';
                }
            });

            // Global variables
            if (project.globals && project.globals.trim()) {
                code += `/* Global Variables */\n${project.globals}\n\n`;
            }

            code += `static int exit_requested = 0;\n\n`;

            // Form pointers
            project.forms.forEach(form => {
                code += `static void *${form.name} = 0;\n`;
            });
            code += '\n';

            // Helper functions
            if (project.helpers && project.helpers.trim()) {
                code += `/* Helper Functions */\n${project.helpers}\n\n`;
            }

            // Standard helpers
            code += `/* Standard Helpers */\n`;
            code += `static void show_msgbox(const char *msg, const char *title) {\n`;
            code += `    msgbox_t box;\n`;
            code += `    win_msgbox_create(&box, msg, "OK", title);\n`;
            code += `    sys_win_show_msgbox(&box);\n`;
            code += `}\n\n`;

            code += `static void show_form(void *form) {\n`;
            code += `    sys_win_draw(form);\n`;
            code += `    sys_win_redraw_all();\n`;
            code += `}\n\n`;

            code += `static void hide_form(void *form) {\n`;
            code += `    sys_win_restore_background(&((gui_form_t*)form)->win);\n`;
            code += `    sys_win_redraw_all();\n`;
            code += `}\n\n`;

            // Control arrays
            project.forms.forEach(form => {
                if (form.controls.length > 0) {
                    code += `/* ${form.name} Controls */\n`;
                    code += `static gui_control_t ${form.name}_controls[] = {\n`;

                    form.controls.forEach((ctrl, i) => {
                        const typeMap = {
                            button: 'CTRL_BUTTON',
                            label: 'CTRL_LABEL',
                            picturebox: 'CTRL_PICTUREBOX',
                            checkbox: 'CTRL_CHECKBOX',
                            radiobutton: 'CTRL_RADIOBUTTON',
                            textbox: 'CTRL_TEXTBOX',
                            frame: 'CTRL_FRAME',
                            dropdown: 'CTRL_DROPDOWN'
                        };

                const escText = ctrl.text.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n');
                        code += `    {${typeMap[ctrl.type]}, ${ctrl.x}, ${ctrl.y}, ${ctrl.w}, ${ctrl.h}, ${ctrl.fg}, ${ctrl.bg}, `;
                        code += `"${escText}", ${ctrl.id}, ${ctrl.font_type}, ${ctrl.font_size}, `;
                        code += `${ctrl.border}, 0, NULL, NULL, 0, ${ctrl.checked}, ${ctrl.group_id}, 0, ${ctrl.max_length}, 0, 0, -1, -1, 0, 0}`;
                        code += i < form.controls.length - 1 ? ',\n' : '\n';
                    });

                    code += `};\n\n`;
                }
            });

            // Event handlers for each form
            project.forms.forEach(form => {
                code += `/* ${form.name} Event Handler */\n`;
                code += `static void ${form.name}_handle_event(void *form_ptr, sys_event_t *event) {\n`;
                code += `    gui_form_t *form = (gui_form_t*)form_ptr;\n\n`;
                
                code += `    if (event->type == EVENT_CLICK) {\n`;
                code += `        int16_t id = event->data[0];\n\n`;
                code += `        switch (id) {\n`;

                // Generate case for each button
                form.controls.filter(c => c.type === 'button').forEach(ctrl => {
                    const idName = `ID_${form.name.toUpperCase()}_${ctrl.id}`;
                    code += `            case ${idName}:\n`;

                    if (ctrl.action.type === 'show_form') {
                        code += `                show_form(${ctrl.action.form_name});\n`;
                    } else if (ctrl.action.type === 'hide_form') {
                        code += `                hide_form(${ctrl.action.form_name});\n`;
                    } else if (ctrl.action.type === 'msgbox') {
                        const msg = (ctrl.action.msg || 'Hello!').replace(/"/g, '\\"');
                        const title = (ctrl.action.msg_title || 'Message').replace(/"/g, '\\"');
                        code += `                show_msgbox("${msg}", "${title}");\n`;
                    } else if (ctrl.action.type === 'set_text') {
                        const targetId = ctrl.action.target_id || 0;
                        const text = (ctrl.action.text_value || '').replace(/"/g, '\\"');
                        code += `                ctrl_set_text(form, ${targetId}, "${text}");\n`;
                        code += `                sys_win_draw(form);\n`;
                    } else if (ctrl.action.type === 'exit') {
                        code += `                exit_requested = 1;\n`;
                    } else if (ctrl.action.type === 'custom' && ctrl.action.custom_code) {
                        const lines = ctrl.action.custom_code.split('\n');
                        lines.forEach(line => {
                            code += `                ${line}\n`;
                        });
                    } else {
                        code += `                /* TODO: implement action */\n`;
                    }

                    code += `                break;\n\n`;
                });

                code += `            default:\n`;
                code += `                break;\n`;
                code += `        }\n`;
                code += `    }\n`;
                code += `}\n\n`;
            });

            // Main entry point
            if (project.type === 'module') {
                code += `/* Module Entry Point */\n`;
                code += `void module_init(void) {\n`;
            } else {
                code += `/* ELF Entry Point */\n`;
                code += `__attribute__((section(".entry"), used))\n`;
                code += `void _start(void) {\n`;
            }

            // Create forms
            project.forms.forEach(form => {
                code += `    ${form.name} = sys_win_create_form(${form.x}, ${form.y}, ${form.w}, ${form.h}, "${form.title}");\n`;
                if (form.controls.length > 0) {
                    code += `    for (int i = 0; i < sizeof(${form.name}_controls) / sizeof(gui_control_t); i++) {\n`;
                    code += `        sys_win_add_control(${form.name}, &${form.name}_controls[i]);\n`;
                    code += `    }\n`;
                }
            });

            code += '\n';

            // Show first form
            if (project.forms.length > 0) {
                const firstForm = project.forms[0].name;
                code += `    /* Show first form */\n`;
                code += `    sys_win_draw(${firstForm});\n`;
                code += `    sys_win_redraw_all();\n\n`;

                code += `    /* Event loop */\n`;
                code += `    sys_win_run_event_loop(${firstForm}, ${firstForm}_handle_event, &exit_requested);\n\n`;
            }

            // Cleanup
            project.forms.forEach(form => {
                code += `    sys_win_destroy_form(${form.name});\n`;
            });

            if (project.type === 'module') {
                code += `}\n`;
            } else {
                code += `    sys_exit();\n`;
                code += `}\n`;
            }

            // Update code editor
            document.getElementById('code-editor').value = code;
        }

        // Keyboard Shortcuts
        function handleKeyboard(e) {
            // Ignore if typing in input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveProject();
            }
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                openProject();
            }
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportCode();
            }
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            }
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                duplicateSelected();
            }
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                toggleGrid();
            }
            if (e.key === 'F7') {
                e.preventDefault();
                toggleCode();
            }
            if (e.key === 'Delete') {
                deleteSelected();
            }
        }

        // Undo/Redo
        function saveState() {
            const stateSnapshot = JSON.stringify(state.project);
            state.undoStack.push(stateSnapshot);
            if (state.undoStack.length > 50) state.undoStack.shift();
            state.redoStack = [];
        }

        function undo() {
            if (state.undoStack.length === 0) return;
            const current = JSON.stringify(state.project);
            state.redoStack.push(current);
            const prev = state.undoStack.pop();
            state.project = JSON.parse(prev);
            updateUI();
        }

        function redo() {
            if (state.redoStack.length === 0) return;
            const current = JSON.stringify(state.project);
            state.undoStack.push(current);
            const next = state.redoStack.pop();
            state.project = JSON.parse(next);
            updateUI();
        }

        // Menu Actions
        function newProject() {
            if (confirm('Create new project? Current work will be lost.')) {
                state.project = {
                    name: 'myapp',
                    type: 'elf',
                    globals: '',
                    helpers: '',
                    forms: []
                };
                state.currentFormIndex = -1;
                state.undoStack = [];
                state.redoStack = [];
                addForm();
                updateUI();
            }
        }

        function saveProject() {
            const json = JSON.stringify(state.project, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.project.name}_project.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function openProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        state.project = JSON.parse(e.target.result);
                        state.currentFormIndex = state.project.forms.length > 0 ? 0 : -1;
                        updateUI();
                    } catch (err) {
                        alert('Failed to load project: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportCode() {
            const code = document.getElementById('code-editor').value;
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.project.name}.c`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importCode() {
            document.getElementById('import-file-input').value = '';
            showModal('import-modal');
        }

        function parseImportedFile() {
            const fileInput = document.getElementById('import-file-input');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a .c file first!');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const code = e.target.result;
                    console.log('[Import] parseImportedFile called with file length:', code.length);
                    const forms = parseCode(code);
                    console.log('[Import] parseCode returned:', forms);
                    
                    if (forms.length === 0) {
                        alert('No valid form declarations found.\n\nSupported formats:\n• sys_win_create_form(&form, x, y, w, h, "Title");\n• sys_win_create_form("Title", x, y, w, h);\n• static gui_control_t controls[] = {...};');
                        return;
                    }
                    
                    // Add forms to project
                    const startIndex = state.project.forms.length;
                    forms.forEach(form => {
                        state.project.forms.push(form);
                    });
                    
                    closeModal('import-modal');
                    if (forms.length > 0) {
                        selectFormInList(startIndex);
                    }
                    updateUI();
                    
                    alert(`Successfully imported ${forms.length} form(s) with ${forms.reduce((sum, f) => sum + f.controls.length, 0)} control(s)!`);
                } catch (err) {
                    alert('Failed to parse file: ' + err.message + '\n\nMake sure the file is a valid osLET C program.');
                    console.error('Import error:', err);
                }
            };
            
            reader.readAsText(file);
        }

        function parseCode(code) {
            const forms = [];
            const typeMap = {
                '1': 'button', 'CTRL_BUTTON': 'button',
                '2': 'label', 'CTRL_LABEL': 'label',
                '3': 'picturebox', 'CTRL_PICTUREBOX': 'picturebox',
                '4': 'checkbox', 'CTRL_CHECKBOX': 'checkbox',
                '5': 'radiobutton', 'CTRL_RADIOBUTTON': 'radiobutton',
                '6': 'textbox', 'CTRL_TEXTBOX': 'textbox',
                '7': 'frame', 'CTRL_FRAME': 'frame',
                '9': 'dropdown', 'CTRL_DROPDOWN': 'dropdown'
            };

            console.log('[Import] Starting parseCode...');

            // Try new format: sys_win_create_form(&form, x, y, w, h, "title");
            let formRegex = /sys_win_create_form\s*\(\s*&[^,]+,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*"([^"]+)"\s*\)/g;
            let matches = [...code.matchAll(formRegex)];
            
            console.log('[Import] New format matches:', matches.length);
            
            // Try legacy format: form = sys_win_create_form("title", x, y, w, h);
            if (matches.length === 0) {
                formRegex = /sys_win_create_form\s*\(\s*"([^"]+)"\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/g;
                matches = [...code.matchAll(formRegex)];
                
                console.log('[Import] Legacy format matches:', matches.length);
                
                matches.forEach(match => {
                    const form = {
                        name: match[1].replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase(),
                        title: match[1],
                        x: parseInt(match[2]),
                        y: parseInt(match[3]),
                        w: parseInt(match[4]),
                        h: parseInt(match[5]),
                        controls: [],
                        nextControlId: 0
                    };
                    console.log('[Import] Created legacy form:', form);
                    forms.push(form);
                });
            } else {
                // New format
                matches.forEach(match => {
                    forms.push({
                        name: match[5].replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase(),
                        title: match[5],
                        x: parseInt(match[1]),
                        y: parseInt(match[2]),
                        w: parseInt(match[3]),
                        h: parseInt(match[4]),
                        controls: [],
                        nextControlId: 0
                    });
                });
            }

            if (forms.length === 0) return forms;

            console.log('[Import] Forms created:', forms.length, forms);

            // Parse legacy static array format: static gui_control_t controls[] = { ... };
            // Need to match all content between outer braces, including nested braces
            const arrayRegex = /static\s+gui_control_t\s+\w+\[\]\s*=\s*\{([\s\S]*?)\};/;
            const arrayMatch = code.match(arrayRegex);
            
            console.log('[Import] Array match found:', !!arrayMatch);
            
            if (arrayMatch && forms.length > 0) {
                console.log('[Import] Parsing legacy control array...');
                // Parse each struct initializer
                // Extract each {...} block representing one control
                const structBlocks = [];
                const arrayContent = arrayMatch[1];
                let depth = 0;
                let currentBlock = '';
                let inString = false;
                let escapeNext = false;
                
                for (let i = 0; i < arrayContent.length; i++) {
                    const char = arrayContent[i];
                    
                    if (escapeNext) {
                        currentBlock += char;
                        escapeNext = false;
                        continue;
                    }
                    
                    if (char === '\\') {
                        escapeNext = true;
                        currentBlock += char;
                        continue;
                    }
                    
                    if (char === '"') {
                        inString = !inString;
                        currentBlock += char;
                        continue;
                    }
                    
                    if (!inString) {
                        if (char === '{') {
                            depth++;
                            if (depth === 1) {
                                currentBlock = '';
                                continue;
                            }
                        } else if (char === '}') {
                            depth--;
                            if (depth === 0) {
                                if (currentBlock.trim()) {
                                    structBlocks.push(currentBlock.trim());
                                }
                                currentBlock = '';
                                continue;
                            }
                        }
                    }
                    
                    if (depth > 0) {
                        currentBlock += char;
                    }
                }
                
                console.log(`[Import] Extracted ${structBlocks.length} struct blocks`);
                
                // Now parse each struct block
                structBlocks.forEach((block, idx) => {
                    // Split by commas, respecting strings
                    const fields = [];
                    let currentField = '';
                    let inString = false;
                    let escapeNext = false;
                    
                    for (let i = 0; i < block.length; i++) {
                        const char = block[i];
                        
                        if (escapeNext) {
                            currentField += char;
                            escapeNext = false;
                            continue;
                        }
                        
                        if (char === '\\') {
                            escapeNext = true;
                            currentField += char;
                            continue;
                        }
                        
                        if (char === '"') {
                            inString = !inString;
                            currentField += char;
                            continue;
                        }
                        
                        if (!inString && char === ',') {
                            fields.push(currentField.trim());
                            currentField = '';
                            continue;
                        }
                        
                        currentField += char;
                    }
                    if (currentField.trim()) {
                        fields.push(currentField.trim());
                    }
                    
                    console.log(`[Import] Control ${idx}: ${fields.length} fields, type=${fields[0]}`);
                    
                    // Extract the fields we need (positions 0-12)
                    if (fields.length >= 13) {
                        const typeStr = fields[0].trim();
                        const mappedType = typeMap[typeStr];
                        
                        if (!mappedType) {
                            console.warn(`[Import] Unknown control type: ${typeStr}, defaulting to label`);
                        }
                        
                        const control = {
                            id: forms[0].nextControlId++,
                            type: mappedType || 'label',
                            x: parseInt(fields[1]) || 0,
                            y: parseInt(fields[2]) || 0,
                            w: parseInt(fields[3]) || 0,
                            h: parseInt(fields[4]) || 0,
                            fg: parseInt(fields[5]) || 0,
                            bg: parseInt(fields[6]) || -1,
                            text: fields[7].replace(/^"(.*)"$/, '$1'), // Remove quotes
                            font_type: parseInt(fields[9]) || 0,
                            font_size: parseInt(fields[10]) || 12,
                            border: parseInt(fields[11]) || 0,
                            border_color: parseInt(fields[12]) || 0,
                            checked: 0,
                            group_id: 0,
                            max_length: typeStr === 'CTRL_TEXTBOX' || typeStr === '6' ? 255 : 0,
                            enabled: 1,
                            visible: 1,
                            action: { type: 'none' }
                        };
                        
                        // Validate control object
                        if (!control.type) {
                            console.error(`[Import] Control ${idx} has no type! TypeStr: ${typeStr}`);
                            return;
                        }
                        
                        console.log(`[Import] Created control ${idx}: type=${control.type}, x=${control.x}, y=${control.y}, text="${control.text}"`);
                        forms[0].controls.push(control);
                    } else {
                        console.warn(`[Import] Skipping control ${idx}: only ${fields.length} fields (need 13+)`);
                    }
                });
                
                console.log(`[Import] Total controls added: ${forms[0].controls.length}`);
            } else {
                // Try new format control parsing: sys_win_add_control(&form, &controls[i], type, x, y, w, h, "text");
                const ctrlRegex = /sys_win_add_control\s*\([^,]+,\s*[^,]+,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*"([^"]*)"\s*\)/g;
                const ctrlMatches = [...code.matchAll(ctrlRegex)];
                
                ctrlMatches.forEach((match, idx) => {
                    if (forms.length === 0) return;
                    
                    const control = {
                        id: forms[0].nextControlId++,
                        type: typeMap[match[1]] || 'label',
                        x: parseInt(match[2]),
                        y: parseInt(match[3]),
                        w: parseInt(match[4]),
                        h: parseInt(match[5]),
                        text: match[6],
                        fg: 0,
                        bg: -1,
                        font_size: 12,
                        font_type: 0,
                        border: 0,
                        border_color: 0,
                        checked: 0,
                        group_id: 0,
                        max_length: match[1] === '6' ? 255 : 0,
                        enabled: 1,
                        visible: 1,
                        action: { type: 'none' }
                    };
                    
                    forms[0].controls.push(control);
                });
            }

            console.log('[Import] parseCode returning:', forms.length, 'forms with controls:', forms.map(f => f.controls.length));
            return forms;
        }

        function deleteSelected() {
            if (!state.selectedControl) return;
            const form = state.project.forms[state.currentFormIndex];
            const index = form.controls.indexOf(state.selectedControl);
            if (index >= 0) {
                state.selectedControl.el.remove();
                form.controls.splice(index, 1);
                state.selectedControl = null;
                saveState();
                generateCode();
                updateFormsListUI();
            }
        }

        function duplicateSelected() {
            if (!state.selectedControl) return;
            const form = state.project.forms[state.currentFormIndex];
            const copy = JSON.parse(JSON.stringify(state.selectedControl));
            copy.id = form.nextControlId++;
            copy.x += 10;
            copy.y += 10;
            delete copy.el;
            form.controls.push(copy);
            createControlElement(copy, document.querySelector('.form-content'));
            selectControl(copy);
            saveState();
            generateCode();
            updateFormsListUI();
        }

        function toggleGrid() {
            document.getElementById('canvas').classList.toggle('grid-enabled');
        }

        function toggleCode() {
            document.getElementById('code-panel').classList.toggle('open');
        }

        function updateGrid() {
            state.gridSize = parseInt(document.getElementById('grid-size').value) || 8;
        }

        function updateSnapToGrid() {
            state.snapToGrid = document.getElementById('snap-to-grid').checked;
        }

        function copyCode() {
            const code = document.getElementById('code-editor').value;
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied to clipboard!');
            });
        }

        // Alignment Tools
        function alignControls(direction) {
            const form = state.project.forms[state.currentFormIndex];
            if (!form || !state.selectedControl) {
                alert('Select a control first!');
                return;
            }

            const selected = state.selectedControl;
            
            // Get reference value from selected control
            let refValue = direction === 'left' ? selected.x :
                          direction === 'right' ? (selected.x + selected.w) :
                          direction === 'top' ? selected.y :
                          (selected.y + selected.h);

            // For single control, snap to common alignment points
            if (direction === 'left') {
                selected.x = Math.round(selected.x / state.gridSize) * state.gridSize;
            } else if (direction === 'right') {
                selected.x = Math.round((selected.x + selected.w) / state.gridSize) * state.gridSize - selected.w;
            } else if (direction === 'top') {
                selected.y = Math.round(selected.y / state.gridSize) * state.gridSize;
            } else if (direction === 'bottom') {
                selected.y = Math.round((selected.y + selected.h) / state.gridSize) * state.gridSize - selected.h;
            }

            // Update visual
            selected.el.style.left = selected.x + 'px';
            selected.el.style.top = selected.y + 'px';
            updatePropertiesPanel(selected);
            saveState();
            generateCode();
        }

        function sameSize(dimension) {
            const form = state.project.forms[state.currentFormIndex];
            if (!form || !state.selectedControl) {
                alert('Select a control first!');
                return;
            }

            const selected = state.selectedControl;
            
            // Round to common sizes
            if (dimension === 'width') {
                const commonWidths = [50, 80, 100, 120, 150, 200];
                const closest = commonWidths.reduce((prev, curr) => 
                    Math.abs(curr - selected.w) < Math.abs(prev - selected.w) ? curr : prev
                );
                selected.w = closest;
                selected.el.style.width = selected.w + 'px';
            } else if (dimension === 'height') {
                const commonHeights = [20, 25, 30, 40, 50, 100];
                const closest = commonHeights.reduce((prev, curr) => 
                    Math.abs(curr - selected.h) < Math.abs(prev - selected.h) ? curr : prev
                );
                selected.h = closest;
                if (selected.type !== 'checkbox' && selected.type !== 'radiobutton') {
                    selected.el.style.height = selected.h + 'px';
                }
            }

            updatePropertiesPanel(selected);
            saveState();
            generateCode();
        }

        // Modal Management
        function projectSettings() {
            document.getElementById('modal-project-name').value = state.project.name;
            document.getElementById('modal-project-type').value = state.project.type;
            showModal('project-settings-modal');
        }

        function applyProjectSettings() {
            state.project.name = document.getElementById('modal-project-name').value;
            state.project.type = document.getElementById('modal-project-type').value;
            document.getElementById('project-name').textContent = state.project.name;
            document.getElementById('project-type').textContent = state.project.type === 'module' ? 'Progman Module' : 'ELF Binary';
            closeModal('project-settings-modal');
            generateCode();
        }

        function showGlobals() {
            document.getElementById('globals-editor').value = state.project.globals || '/* Example:\nstatic int counter = 0;\nstatic char buffer[256];\n*/';
            showModal('globals-modal');
        }

        function saveGlobals() {
            state.project.globals = document.getElementById('globals-editor').value;
            closeModal('globals-modal');
            generateCode();
        }

        function showHelpers() {
            document.getElementById('helpers-editor').value = state.project.helpers || '/* Example:\nstatic void show_error(const char *msg) {\n    msgbox_t box;\n    win_msgbox_create(&box, msg, "OK", "Error");\n    sys_win_show_msgbox(&box);\n}\n*/';
            showModal('helpers-modal');
        }

        function saveHelpers() {
            state.project.helpers = document.getElementById('helpers-editor').value;
            closeModal('helpers-modal');
            generateCode();
        }

        function showSnippets() {
            showModal('snippets-modal');
        }

        function loadSnippets() {
            const list = document.getElementById('snippets-list');
            list.innerHTML = '';
            codeSnippets.forEach(snippet => {
                const item = document.createElement('div');
                item.className = 'snippet-item';
                item.innerHTML = `
                    <div class="snippet-name">${snippet.name}</div>
                    <div class="snippet-desc">${snippet.desc}</div>
                `;
                item.onclick = () => {
                    navigator.clipboard.writeText(snippet.code).then(() => {
                        alert(`"${snippet.name}" copied to clipboard!`);
                    });
                };
                list.appendChild(item);
            });
        }

        function showModal(id) {
            document.getElementById(id).classList.add('visible');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('visible');
        }

        // UI Update
        function updateUI() {
            document.getElementById('project-name').textContent = state.project.name;
            document.getElementById('project-type').textContent = state.project.type === 'module' ? 'Progman Module' : 'ELF Binary';
            updateFormsListUI();
            if (state.currentFormIndex >= 0) {
                displayForm(state.currentFormIndex);
            }
            generateCode();
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
