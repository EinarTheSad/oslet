#include <stdint.h>
#include <stddef.h>
#include "../console.h"
#include "../io.h"

#define VGA_ADDRESS 0xB8000u
#define VGA_WIDTH   80
#define VGA_HEIGHT  25

static volatile uint16_t* const VGA = (volatile uint16_t*)(uintptr_t)VGA_ADDRESS;
static uint8_t vga_color = 0x07;
static int cx = 0, cy = 0;

static uint8_t saved_sequencer[5];
static uint8_t saved_crtc[25];
static uint8_t saved_graphics[9];
static uint8_t saved_attribute[21];
static uint8_t saved_misc;
static int state_saved = 0;

/* 8x16 font */
static const uint8_t console_font_8x16[256][16] = {
    /* 0x00 - NULL */
    [0x00] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    /* Space 0x20 */
    [0x20] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    /* ! 0x21 */
    [0x21] = {0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18,
              0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    
    /* " 0x22 */
    [0x22] = {0x00, 0x66, 0x66, 0x66, 0x24, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    /* # 0x23 */
    [0x23] = {0x00, 0x00, 0x00, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C,
              0x6C, 0xFE, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00},
    
    /* $ 0x24 */
    [0x24] = {0x18, 0x18, 0x7C, 0xC6, 0xC2, 0xC0, 0x7C, 0x06,
              0x06, 0x86, 0xC6, 0x7C, 0x18, 0x18, 0x00, 0x00},
    
    /* % 0x25 */
    [0x25] = {0x00, 0x00, 0x00, 0x00, 0xC2, 0xC6, 0x0C, 0x18,
              0x30, 0x60, 0xC6, 0x86, 0x00, 0x00, 0x00, 0x00},
    
    /* & 0x26 */
    [0x26] = {0x00, 0x00, 0x38, 0x6C, 0x6C, 0x38, 0x76, 0xDC,
              0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},
    
    /* ' 0x27 */
    [0x27] = {0x00, 0x30, 0x30, 0x30, 0x60, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    /* ( 0x28 */
    [0x28] = {0x00, 0x00, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30,
              0x30, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00},
    
    /* ) 0x29 */
    [0x29] = {0x00, 0x00, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C,
              0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},
    
    /* * 0x2A */
    [0x2A] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3C, 0xFF,
              0x3C, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    /* + 0x2B */
    [0x2B] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E,
              0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    /* , 0x2C */
    [0x2C] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00},
    
    /* - 0x2D */
    [0x2D] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE,
              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    /* . 0x2E */
    [0x2E] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    
    /* / 0x2F */
    [0x2F] = {0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x0C, 0x18,
              0x30, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00},
    
    /* 0-9 0x30-0x39 */
    [0x30] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xCE, 0xDE, 0xF6,
              0xE6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x31] = {0x00, 0x00, 0x18, 0x38, 0x78, 0x18, 0x18, 0x18,
              0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00},
    [0x32] = {0x00, 0x00, 0x7C, 0xC6, 0x06, 0x0C, 0x18, 0x30,
              0x60, 0xC0, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00},
    [0x33] = {0x00, 0x00, 0x7C, 0xC6, 0x06, 0x06, 0x3C, 0x06,
              0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x34] = {0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE,
              0x0C, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00},
    [0x35] = {0x00, 0x00, 0xFE, 0xC0, 0xC0, 0xC0, 0xFC, 0x06,
              0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x36] = {0x00, 0x00, 0x38, 0x60, 0xC0, 0xC0, 0xFC, 0xC6,
              0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x37] = {0x00, 0x00, 0xFE, 0xC6, 0x06, 0x06, 0x0C, 0x18,
              0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00},
    [0x38] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0xC6,
              0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x39] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7E, 0x06,
              0x06, 0x06, 0x0C, 0x78, 0x00, 0x00, 0x00, 0x00},
    
    /* : ; < = > ? @ 0x3A-0x40 */
    [0x3A] = {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
              0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},
    [0x3B] = {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
              0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},
    [0x3C] = {0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60,
              0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00},
    [0x3D] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00,
              0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    [0x3E] = {0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06,
              0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00},
    [0x3F] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x0C, 0x18, 0x18,
              0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    [0x40] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xDE, 0xDE, 0xDE,
              0xDC, 0xC0, 0xC1, 0x7E, 0x00, 0x00, 0x00, 0x00},
    
    /* A-Z 0x41-0x5A */
    [0x41] = {0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6, 0xC6, 0xFE,
              0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    [0x42] = {0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66,
              0x66, 0x66, 0x66, 0xFC, 0x00, 0x00, 0x00, 0x00},
    [0x43] = {0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xC0,
              0xC0, 0xC2, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00},
    [0x44] = {0x00, 0x00, 0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66,
              0x66, 0x66, 0x6C, 0xF8, 0x00, 0x00, 0x00, 0x00},
    [0x45] = {0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
              0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00},
    [0x46] = {0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
              0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},
    [0x47] = {0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xDE,
              0xC6, 0xC6, 0x66, 0x3A, 0x00, 0x00, 0x00, 0x00},
    [0x48] = {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xFE, 0xC6,
              0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    [0x49] = {0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18,
              0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    [0x4A] = {0x00, 0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
              0xCC, 0xCC, 0xCC, 0x78, 0x00, 0x00, 0x00, 0x00},
    [0x4B] = {0x00, 0x00, 0xE6, 0x66, 0x66, 0x6C, 0x78, 0x78,
              0x6C, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},
    [0x4C] = {0x00, 0x00, 0xF0, 0x60, 0x60, 0x60, 0x60, 0x60,
              0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00},
    [0x4D] = {0x00, 0x00, 0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6,
              0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    [0x4E] = {0x00, 0x00, 0xC6, 0xE6, 0xF6, 0xFE, 0xDE, 0xCE,
              0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    [0x4F] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
              0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x50] = {0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x60,
              0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},
    [0x51] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
              0xC6, 0xD6, 0xDE, 0x7C, 0x0C, 0x0E, 0x00, 0x00},
    [0x52] = {0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x6C,
              0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},
    [0x53] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x60, 0x38, 0x0C,
              0x06, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x54] = {0x00, 0x00, 0x7E, 0x7E, 0x5A, 0x18, 0x18, 0x18,
              0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    [0x55] = {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
              0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x56] = {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
              0xC6, 0x6C, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00},
    [0x57] = {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xD6, 0xD6,
              0xD6, 0xFE, 0xEE, 0x6C, 0x00, 0x00, 0x00, 0x00},
    [0x58] = {0x00, 0x00, 0xC6, 0xC6, 0x6C, 0x7C, 0x38, 0x38,
              0x7C, 0x6C, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    [0x59] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18,
              0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    [0x5A] = {0x00, 0x00, 0xFE, 0xC6, 0x86, 0x0C, 0x18, 0x30,
              0x60, 0xC2, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00},
    
    /* [ \ ] ^ _ ` 0x5B-0x60 */
    [0x5B] = {0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30,
              0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00, 0x00},
    [0x5C] = {0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0x70, 0x38,
              0x1C, 0x0E, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00},
    [0x5D] = {0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
              0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00, 0x00},
    [0x5E] = {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    [0x5F] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00},
    [0x60] = {0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    /* a-z 0x61-0x7A */
    [0x61] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x0C, 0x7C,
              0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},
    [0x62] = {0x00, 0x00, 0xE0, 0x60, 0x60, 0x78, 0x6C, 0x66,
              0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x63] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC0,
              0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x64] = {0x00, 0x00, 0x1C, 0x0C, 0x0C, 0x3C, 0x6C, 0xCC,
              0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},
    [0x65] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xFE,
              0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x66] = {0x00, 0x00, 0x38, 0x6C, 0x64, 0x60, 0xF0, 0x60,
              0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},
    [0x67] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
              0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0xCC, 0x78, 0x00},
    [0x68] = {0x00, 0x00, 0xE0, 0x60, 0x60, 0x6C, 0x76, 0x66,
              0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},
    [0x69] = {0x00, 0x00, 0x18, 0x18, 0x00, 0x38, 0x18, 0x18,
              0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    [0x6A] = {0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06,
              0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00},
    [0x6B] = {0x00, 0x00, 0xE0, 0x60, 0x60, 0x66, 0x6C, 0x78,
              0x78, 0x6C, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},
    [0x6C] = {0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18,
              0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},
    [0x6D] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xEC, 0xFE, 0xD6,
              0xD6, 0xD6, 0xD6, 0xC6, 0x00, 0x00, 0x00, 0x00},
    [0x6E] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
              0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00},
    [0x6F] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6,
              0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x70] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
              0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00},
    [0x71] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
              0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0x0C, 0x1E, 0x00},
    [0x72] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x76, 0x66,
              0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},
    [0x73] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0x60,
              0x38, 0x0C, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},
    [0x74] = {0x00, 0x00, 0x10, 0x30, 0x30, 0xFC, 0x30, 0x30,
              0x30, 0x30, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00},
    [0x75] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xCC, 0xCC, 0xCC,
              0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},
    [0x76] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66,
              0x66, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00},
    [0x77] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xD6,
              0xD6, 0xD6, 0xFE, 0x6C, 0x00, 0x00, 0x00, 0x00},
    [0x78] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0x6C, 0x38,
              0x38, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00},
    [0x79] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xC6,
              0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0xF8, 0x00},
    [0x7A] = {0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xCC, 0x18,
              0x30, 0x60, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00},
    
    /* { | } ~ 0x7B-0x7E */
    [0x7B] = {0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18,
              0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00},
    [0x7C] = {0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18,
              0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
    [0x7D] = {0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18,
              0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00},
    [0x7E] = {0x00, 0x00, 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    [0x7F] = {0x00, 0x00, 0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6,
              0xC6, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00},
};

static const uint8_t default_palette[16][3] = {
    {0x00, 0x00, 0x00},  /* 0: Black */
    {0x00, 0x00, 0xAA},  /* 1: Blue */
    {0x00, 0xAA, 0x00},  /* 2: Green */
    {0x00, 0xAA, 0xAA},  /* 3: Cyan */
    {0xAA, 0x00, 0x00},  /* 4: Red */
    {0xAA, 0x00, 0xAA},  /* 5: Magenta */
    {0xAA, 0x55, 0x00},  /* 6: Brown */
    {0xAA, 0xAA, 0xAA},  /* 7: Light Gray */
    {0x55, 0x55, 0x55},  /* 8: Dark Gray */
    {0x55, 0x55, 0xFF},  /* 9: Light Blue */
    {0x55, 0xFF, 0x55},  /* 10: Light Green */
    {0x55, 0xFF, 0xFF},  /* 11: Light Cyan */
    {0xFF, 0x55, 0x55},  /* 12: Light Red */
    {0xFF, 0x55, 0xFF},  /* 13: Light Magenta */
    {0xFF, 0xFF, 0x55},  /* 14: Yellow */
    {0xFF, 0xFF, 0xFF},  /* 15: White */
};

void vga_save_state(void) {
    saved_misc = inb(0x3CC);
    
    for (uint8_t i = 0; i < 5; i++) {
        outb(0x3C4, i);
        saved_sequencer[i] = inb(0x3C5);
    }
    
    for (uint8_t i = 0; i < 25; i++) {
        outb(0x3D4, i);
        saved_crtc[i] = inb(0x3D5);
    }
    
    for (uint8_t i = 0; i < 9; i++) {
        outb(0x3CE, i);
        saved_graphics[i] = inb(0x3CF);
    }
    
    (void)inb(0x3DA);
    for (uint8_t i = 0; i < 21; i++) {
        outb(0x3C0, i);
        saved_attribute[i] = inb(0x3C1);
    }
    outb(0x3C0, 0x20);
    
    state_saved = 1;
}

void vga_restore_state(void) {
    if (!state_saved) return;
    
    outb(0x3C2, saved_misc);
    
    for (uint8_t i = 0; i < 5; i++) {
        outb(0x3C4, i);
        outb(0x3C5, saved_sequencer[i]);
    }
    
    outb(0x3D4, 0x03);
    outb(0x3D5, inb(0x3D5) | 0x80);
    outb(0x3D4, 0x11);
    outb(0x3D5, inb(0x3D5) & 0x7F);
    
    for (uint8_t i = 0; i < 25; i++) {
        outb(0x3D4, i);
        outb(0x3D5, saved_crtc[i]);
    }
    
    for (uint8_t i = 0; i < 9; i++) {
        outb(0x3CE, i);
        outb(0x3CF, saved_graphics[i]);
    }
    
    (void)inb(0x3DA);
    for (uint8_t i = 0; i < 21; i++) {
        outb(0x3C0, i);
        outb(0x3C0, saved_attribute[i]);
    }
    outb(0x3C0, 0x20);
}

static void vga_load_font(void) {
    uint8_t seq2, seq4, gc4, gc5, gc6;
    
    outb(0x3C4, 0x02);
    seq2 = inb(0x3C5);
    
    outb(0x3C4, 0x04);
    seq4 = inb(0x3C5);
    
    outb(0x3CE, 0x04);
    gc4 = inb(0x3CF);
    
    outb(0x3CE, 0x05);
    gc5 = inb(0x3CF);
    
    outb(0x3CE, 0x06);
    gc6 = inb(0x3CF);
    
    /* Font injection */
    outb(0x3C4, 0x02);
    outb(0x3C5, 0x04);  /* Plane 2 */
    
    outb(0x3C4, 0x04);
    outb(0x3C5, 0x07);  /* Sequential addressing */
    
    outb(0x3CE, 0x04);
    outb(0x3CF, 0x02);  /* Read plane 2 */
    
    outb(0x3CE, 0x05);
    outb(0x3CF, 0x00);  /* Write mode 0 */
    
    outb(0x3CE, 0x06);
    outb(0x3CF, 0x00);  /* Map A0000-BFFFF */
    
    /* Load font into VGA memory (plane 2) */
    volatile uint8_t* font_mem = (volatile uint8_t*)0xA0000;
    
    for (int ch = 0; ch < 256; ch++) {
        for (int row = 0; row < 16; row++) {
            font_mem[ch * 32 + row] = console_font_8x16[ch][row];
        }
    }
    
    outb(0x3C4, 0x02);
    outb(0x3C5, seq2);
    
    outb(0x3C4, 0x04);
    outb(0x3C5, seq4);
    
    outb(0x3CE, 0x04);
    outb(0x3CF, gc4);
    
    outb(0x3CE, 0x05);
    outb(0x3CF, gc5);
    
    outb(0x3CE, 0x06);
    outb(0x3CF, gc6);
}

static inline void clamp_cursor(void) {
    if (cx < 0) cx = 0;
    if (cy < 0) cy = 0;
    if (cx >= VGA_WIDTH)  cx = VGA_WIDTH - 1;
    if (cy >= VGA_HEIGHT) cy = VGA_HEIGHT - 1;
}

static inline void move_hw_cursor(void) {
    clamp_cursor();
    uint16_t pos = (uint16_t)(cy * VGA_WIDTH + cx);
    outb(0x3D4, 0x0F);
    outb(0x3D5, (uint8_t)(pos & 0xFF));
    outb(0x3D4, 0x0E);
    outb(0x3D5, (uint8_t)(pos >> 8));
}

static inline void put_at(char c, int x, int y) {
    if ((unsigned)x < VGA_WIDTH && (unsigned)y < VGA_HEIGHT) {
        VGA[y * VGA_WIDTH + x] = (uint16_t)c | ((uint16_t)vga_color << 8);
    }
}

static inline void enable_cursor(uint8_t cursor_start, uint8_t cursor_end) {
    outb(0x3D4, 0x0A);
    outb(0x3D5, (inb(0x3D5) & 0xC0) | cursor_start);

    outb(0x3D4, 0x0B);
    outb(0x3D5, (inb(0x3D5) & 0xE0) | cursor_end);
}

static inline void disable_cursor(void) {
    outb(0x3D4, 0x0A);
    outb(0x3D5, 0x20);
}

static void scroll_if_needed(void) {
    if (cy < VGA_HEIGHT)
        return;

    for (int y = 1; y < VGA_HEIGHT; ++y) {
        for (int x = 0; x < VGA_WIDTH; ++x) {
            VGA[(y - 1) * VGA_WIDTH + x] = VGA[y * VGA_WIDTH + x];
        }
    }

    uint16_t blank = (uint16_t)(' ') | ((uint16_t)vga_color << 8);
    int last = VGA_HEIGHT - 1;
    for (int x = 0; x < VGA_WIDTH; ++x)
        VGA[last * VGA_WIDTH + x] = blank;

    cy = VGA_HEIGHT - 1;
    if (cx < 0) cx = 0;
    if (cx >= VGA_WIDTH) cx = VGA_WIDTH - 1;
}

static void vga_putc_internal(char c) {
    switch ((unsigned char)c) {
        case '\r':
            cx = 0;
            break;

        case '\n':
            cx = 0;
            cy++;
            break;

        case '\t': {
            int next = (cx + 4) & ~3;
            for (; cx < next && cx < VGA_WIDTH; ++cx)
                put_at(' ', cx, cy);
        } break;

        case '\b':
            if (cx > 0) {
                cx--;
                put_at(' ', cx, cy);
            }
            break;

        default:
            put_at(c, cx, cy);
            if (++cx >= VGA_WIDTH) {
                cx = 0;
                cy++;
            }
            break;
    }
}

static size_t vga_write(const char* s, size_t n, void* ctx) {
    (void)ctx;
    for (size_t i = 0; i < n; ++i) {
        vga_putc_internal(s[i]);
        if (cy >= VGA_HEIGHT)
            scroll_if_needed();
    }
    move_hw_cursor();
    return n;
}

void vga_clear(void) {
    /* Clear with CURRENT vga_color on purpose */
    uint16_t blank = (uint16_t)(' ') | ((uint16_t)vga_color << 8);
    for (int y = 0; y < VGA_HEIGHT; ++y) {
        for (int x = 0; x < VGA_WIDTH; ++x) {
            VGA[y * VGA_WIDTH + x] = blank;
        }
    }
    cx = 0;
    cy = 0;
    move_hw_cursor();
}

static const console_t VGA_CONSOLE = {
    .write = vga_write,
    .ctx   = 0
};

void vga_use_as_console(void) {
    vga_load_font();
    void vga_reset_palette(void);
    console_set(&VGA_CONSOLE);
    enable_cursor(12, 12);
}

void vga_set_color(uint8_t background, uint8_t foreground) {
    vga_color = (foreground & 0x0F) | ((background & 0x0F) << 4);
}

static void vga_load_palette(const uint8_t palette[16][3]) {
    for (int i = 0; i < 16; i++) {
        outb(0x3C8, i);
        outb(0x3C9, palette[i][0] >> 2);  /* R (6-bit) */
        outb(0x3C9, palette[i][1] >> 2);  /* G (6-bit) */
        outb(0x3C9, palette[i][2] >> 2);  /* B (6-bit) */
    }
}

void vga_reset_palette(void) {
    vga_load_palette(default_palette);
}